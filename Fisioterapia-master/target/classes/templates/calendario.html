<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calendário de Presença</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/src/main/resources/static/css/style.css" />

    <style>
      .calendar-container { max-width: 900px; }
      .calendar-title { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
      .calendar-subtitle { font-size: 18px; margin-bottom: 20px; }
      .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); font-weight: 600; margin-bottom: 10px; text-align: center; }
      .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; }
      .day-circle { width: 48px; height: 48px; border-radius: 50%; font-weight: 600; display: flex; justify-content: center; align-items: center; margin: auto; }
      .sem-aula { background-color: #d9e6ff; }
      .presenca { background-color: #aaff9e; }
      .falta { background-color: #ff8f8f; }
      .falta-justificada { background-color: #ffbf8f; }
      .alta-temp { background-color: #f5ff6a; }
      .legend { margin-left: 50px; }
      .legend-item { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
      .legend-circle { width: 20px; height: 20px; border-radius: 50%; }
    </style>
  </head>

  <body>
    <div class="d-flex">
      <!-- Sidebar -->
      <aside class="sidebar d-flex flex-column align-items-center p-3">
        <div class="logo-container">
          <img src="/src/main/resources/static/images/logo-fisiologia.jpg" alt="Logo" class="logo-img" />
        </div>

        <ul class="nav flex-column w-100">
          <li class="nav-item mb-2">
            <a href="/pacientes" class="nav-link text-white d-flex align-items-center px-3">
              <i class="bi bi-house me-2"></i> Início
            </a>
          </li>

          <li class="nav-item">
            <a href="/calendario" class="nav-link active text-white d-flex align-items-center px-3">
              <i class="bi bi-calendar3 me-2"></i> Calendário
            </a>
          </li>
        </ul>
      </aside>

      <!-- Conteúdo principal -->
      <main class="flex-grow-1 p-5">
        <div class="calendar-container">

          <h2 class="calendar-title">Calendário de presença</h2>

          <!-- Seletor de paciente -->
          <div class="mb-3" style="max-width: 420px;">
            <label class="form-label">Paciente</label>
            <select id="pacienteSelect" class="form-select">
              <option value="">Selecione um paciente</option>
              <!-- opção protótipo para testes rápidos -->
              <option value="__proto__">Paciente Exemplo (teste)</option>
              <option th:each="p : ${pacientes}" th:value="${p.id}" th:text="${p.nomeCompleto}"></option>
            </select>
          </div>

          <p class="calendar-subtitle" id="mesAnoLabel">Novembro de 2025</p>

          <div class="d-flex">
            <div>
              <div class="weekdays">
                <div>Dom.</div>
                <div>Seg.</div>
                <div>Ter.</div>
                <div>Qua.</div>
                <div>Qui.</div>
                <div>Sex.</div>
                <div>Sab.</div>
              </div>

              <div class="calendar-grid" id="calendarGrid">
                <!-- O calendário será gerado via JS (para permitir marcação dinâmica de datas) -->
              </div>
            </div>

            <!-- Legenda -->
            <div class="legend">
              <div class="legend-item"><div class="legend-circle" style="background:#d9e6ff"></div><span>Sem aula</span></div>
              <div class="legend-item"><div class="legend-circle" style="background:#aaff9e"></div><span>Presença</span></div>
              <div class="legend-item"><div class="legend-circle" style="background:#ff8f8f"></div><span>Falta</span></div>
              <div class="legend-item"><div class="legend-circle" style="background:#ffbf8f"></div><span>Falta Justificada</span></div>
              <div class="legend-item"><div class="legend-circle" style="background:#f5ff6a"></div><span>Alta Temporária</span></div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Configuração inicial do mês/ano exibido (pode ser parametrizado)
      const exibicaoAno = 2025;
      const exibicaoMes = 11; // novembro (1-based)

      function criarCalendario(year, month) {
        // month é 1-based (1..12)
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        const first = new Date(year, month - 1, 1);
        const last = new Date(year, month, 0);

        // dia da semana do primeiro dia (0=dom)
        const startDow = first.getDay();
        // número de dias no mês
        const daysInMonth = last.getDate();

        // preenche espaços vazios antes do dia 1
        for (let i = 0; i < startDow; i++) {
          const empty = document.createElement('div');
          grid.appendChild(empty);
        }

        for (let d = 1; d <= daysInMonth; d++) {
          const dayDiv = document.createElement('div');
          const circle = document.createElement('div');
          circle.className = 'day-circle';
          circle.textContent = d;
          // atributo data-date no formato ISO
          const iso = new Date(year, month - 1, d).toISOString().slice(0,10);
          circle.dataset.date = iso;
          dayDiv.appendChild(circle);
          grid.appendChild(dayDiv);
        }
      }

      function limparMarcacoes() {
        document.querySelectorAll('.calendar-grid .day-circle').forEach(el => {
          el.classList.remove('presenca','falta','falta-justificada','sem-aula','alta-temp');
        });
      }

      function aplicarPresencas(presencas) {
        limparMarcacoes();
        presencas.forEach(p => {
          const iso = p.data; // espera yyyy-MM-dd
          const el = document.querySelector(`.day-circle[data-date='${iso}']`);
          if (!el) return;
          const status = (p.status || '').toLowerCase();
          if (status.includes('presen')) el.classList.add('presenca');
          else if (status.includes('falta just')) el.classList.add('falta-justificada');
          else if (status.includes('falta')) el.classList.add('falta');
          else if (status.includes('alta')) el.classList.add('alta-temp');
          else el.classList.add('sem-aula');
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        criarCalendario(exibicaoAno, exibicaoMes);

        const select = document.getElementById('pacienteSelect');
        select.addEventListener('change', async (e) => {
          const id = e.target.value;
          if (!id) { limparMarcacoes(); return; }

          // caso de teste local: paciente protótipo
          if (id === '__proto__') {
            const exemplo = [
              { data: '2025-11-05', status: 'Presença' },
              { data: '2025-11-12', status: 'Falta Justificada' },
              { data: '2025-11-15', status: 'Falta' },
              { data: '2025-11-21', status: 'Presença' },
              { data: '2025-11-26', status: 'Alta Temporária' },
              { data: '2025-11-07', status: 'Sem aula' }
            ];
            aplicarPresencas(exemplo);
            return;
          }

          try {
            const res = await fetch(`/api/pacientes/${id}/presencas`);
            if (!res.ok) throw new Error('Erro ao buscar presenças');
            const data = await res.json();
            aplicarPresencas(data);
          } catch (err) {
            console.error(err);
            alert('Não foi possível carregar as presenças deste paciente.');
          }
        });

        // Se houver opção pré-selecionada (por Thymeleaf), disparar mudança
        if (select.value) {
          select.dispatchEvent(new Event('change'));
        }
      });
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  </body>
</html>
